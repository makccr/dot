#!/usr/bin/env bash

CONFIG="$HOME/.config/alacritty/alacritty.toml"

# Check if config exists
if [[ ! -f "$CONFIG" ]]; then
    notify-send "Alacritty config not found at $CONFIG"
    exit 1
fi

# Backup config
cp "$CONFIG" "$CONFIG.bak"

# Fetch current opacity under [window] section
opacity=$(awk '
    /^\[window\]/ {in_window=1; next}
    /^\[/ {in_window=0}
    in_window && /^opacity *=/ {
        gsub(/ /,"",$0)
        split($0,a,"=")
        print a[2]
        exit
    }
' "$CONFIG")

# Validate opacity
if [[ -z "$opacity" ]]; then
    notify-send "opacity not set under [window] in config"
    exit 1
fi

# Toggle opacity
if (( $(echo "$opacity < 1" | bc -l) )); then
    toggle_opacity=1
else
    toggle_opacity=0.8
fi

# Replace opacity in [window] section
awk -v new_opacity="$toggle_opacity" '
    BEGIN{in_window=0}
    /^\[window\]/ {in_window=1; print; next}
    /^\[/ {in_window=0}
    in_window && /^opacity *=/ {
        sub(/=.*/, "= " new_opacity)
    }
    {print}
' "$CONFIG" > "$CONFIG.tmp" && mv "$CONFIG.tmp" "$CONFIG"

notify-send "Alacritty opacity set to $toggle_opacity"

